name: Create Tag and Release

on:
  push:
    branches:
      - main
    tags:
      - '*'

permissions:
  contents: write

jobs:
  create-tag:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      new-tag: ${{ steps.tag.outputs.new_tag }}
      tag-created: ${{ steps.tag.outputs.tag }}
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: '0'
    - name: Bump version and push tag
      id: tag
      uses: anothrNick/github-tag-action@1.75.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: false
        DEFAULT_BUMP: patch

  create-release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: gd, zip, mbstring
        coverage: none

    - name: Cache Composer packages
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --optimize-autoloader

    - name: Generate eBooks (All Formats)
      run: |
        composer run pdf
        composer run pdf-dark  
        composer run epub
        composer run html
        composer run sample
        composer run sample-dark

    - name: Get tag name
      id: get_tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Get current date
      id: get_date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_tag.outputs.tag }}
        name: "📚 101 Linux Commands eBook v${{ steps.get_tag.outputs.tag }}"
        body: |
          ## 📚 101 Linux Commands eBook - Release v${{ steps.get_tag.outputs.tag }}
          
          **Released on:** ${{ steps.get_date.outputs.date }}
          
          This release contains the latest version of the "101 Linux Commands" eBook in multiple formats, perfect for learning Linux command line skills.
          
          ### 📥 Available Formats
          
          - **📄 PDF (Light Theme)** - `101-linux-commands-light.pdf`
            - Ideal for printing and desktop reading
            - Clean, professional layout with light backgrounds
          
          - **🌙 PDF (Dark Theme)** - `101-linux-commands-dark.pdf`  
            - Perfect for dark mode readers and reduced eye strain
            - Dark backgrounds with light text
          
          - **📱 EPUB** - `101-linux-commands.epub`
            - Compatible with e-readers, tablets, and mobile devices
            - Reflowable text that adapts to your screen size
          
          - **🌐 HTML** - `101-linux-commands.html`
            - Interactive single-page web version
            - Features collapsible sidebar, dark mode toggle, and reading progress
            - Perfect for online reading and bookmarking
          
          - **📑 Sample PDFs** - Preview versions with selected chapters
            - `101-linux-commands-sample-light.pdf`
            - `101-linux-commands-sample-dark.pdf`
          
          ### ✨ What's Included
          
          - **101 Essential Linux Commands** with detailed explanations
          - **Real-world examples** and use cases for each command
          - **Best practices** and tips from experienced developers
          - **Beautiful formatting** optimized for each format
          - **Interactive features** in HTML version (dark mode, font controls, progress tracking)
          
          ### 🚀 Perfect For
          
          - **Beginners** learning Linux for the first time
          - **Developers** switching to Linux development environments  
          - **System administrators** looking for a quick reference
          - **Students** studying for Linux certifications
          - **Anyone** wanting to master the Linux command line
          
          ### 📖 How to Use
          
          1. **Choose your preferred format** from the assets below
          2. **Download the eBook** to your device
          3. **Start learning** Linux commands at your own pace
          4. **Bookmark** this page for future updates
          
          ### 🔄 Updates & Changes
          
          This release was automatically generated from the latest content updates. The eBook is continuously improved based on community feedback and contributions.
          
          ### 🙏 Contributing
          
          Found an issue or want to suggest improvements? 
          - 🐛 [Report bugs](../../issues/new?template=bug_report.md)
          - 💡 [Suggest features](../../issues/new?template=feature_request.md)  
          - 📝 [Contribute content](../../blob/main/CONTRIBUTING.md)
          
          ### 🌟 Support the Project
          
          If this eBook helped you learn Linux, please:
          - ⭐ Star this repository
          - 🐦 Share it with others
          - 💬 Leave feedback in the discussions
          
          ---
          
          **Generated from commit:** ${{ github.sha }}
          **Build date:** ${{ steps.get_date.outputs.date }}
        files: |
          ebook/en/export/101-linux-commands-light.pdf
          ebook/en/export/101-linux-commands-dark.pdf
          ebook/en/export/101-linux-commands.epub
          ebook/en/export/101-linux-commands.html
          ebook/en/export/101-linux-commands-sample-light.pdf
          ebook/en/export/101-linux-commands-sample-dark.pdf
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
